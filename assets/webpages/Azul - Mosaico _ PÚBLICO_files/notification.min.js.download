import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";import{getMessaging,getToken,isSupported,onMessage}from"https://www.gstatic.com/firebasejs/10.7.2/firebase-messaging.js";const serverKey="BJp62DLThd_xobBt5pY95HIs0JkZcWUcD_MkJUjiYGFmoDazLmnNpfkUvzbEsH8D9AjxbOdhL7RaSTgQiIkNVRM";const firebaseConfig={apiKey:"AIzaSyAWXeyAo2OggxJphdqIgZ4YqRqTi531uL8",authDomain:"publico-android.firebaseapp.com",databaseURL:"https://publico-android.firebaseio.com",projectId:"publico-android",storageBucket:"publico-android.appspot.com",messagingSenderId:"578573727010",appId:"1:578573727010:web:242371fea5487cd42ae17b",measurementId:"G-FB5B5CSPJS"};const app=initializeApp(firebaseConfig);const messaging=getMessaging(app);const notificationToggle=document.querySelector("#notifications-toggle");var browserSupported=await isSupported();if(browserSupported){var deferredScripts=window.deferredScripts||[];deferredScripts.push(function(){Publico.Notifications=class{#browsers={EDGE:"Edge",CHROME:"Chrome",SAFARI:"Safari",FIREFOX:"Firefox",UNSUPORTED:"unsuported"};#notificationStatus=Notification.permission;#mainSwitches=document.querySelectorAll(".main-alert-switch");#browser;#token;#notifications=[];#subscribeSwitches=document.querySelectorAll(".receive-alert-btn");#notificationsElement=[];#userAgent=navigator.userAgent;#isMobile=Publico.Utils.IsMobile;#platform=(navigator.userAgentData?navigator.userAgentData.platform:navigator.platform).toLowerCase();#mainSwitchState(state){if(this.#mainSwitches!=null&&this.#mainSwitches.length>0)this.#mainSwitches.forEach(el=>{el.checked=state})}#initMessaging(){this.#mainSwitchState(true);onMessage(messaging,payload=>{const notificationTitle=payload.notification.title;const notificationUrl=payload.fcmOptions.link;const notificationOptions={body:payload.notification.body,badge:payload.notification.icon,image:payload.notification.image,data:payload.data,tag:payload.notification.body};var notification=new Notification(notificationTitle,notificationOptions);self.fetch("https://notifications.publico.pt/v1/ping",{method:"post",headers:new Headers({"content-type":"application/json"}),credentials:"include",body:JSON.stringify({title:notificationTitle,url:notificationUrl,action:"received"})});notification.onclick=function(event){event.preventDefault();window.open(payload.fcmOptions.link,"_blank");notification.close();self.fetch("https://notifications.publico.pt/v1/ping",{method:"post",headers:new Headers({"content-type":"application/json"}),credentials:"include",body:JSON.stringify({title:notificationTitle,url:notificationUrl,action:"clicked"})})}});getToken(messaging,{vapidKey:serverKey}).then(token=>{if(token){this.#token=token;window.firebaseMessagingToken=token;var sessionToken=sessionStorage.getItem("fb_tk");if(sessionToken==null||sessionToken!=token){fetch("/api/notification/subscribe?token="+token,{credentials:"include"});sessionStorage.setItem("fb_tk",token)}if(this.#notificationsElement.length>0)this.#getUserSubscriptions(token);Publico.Track.Event("notifications","action","allowed")}}).catch(err=>{Publico.Track.Event("notifications","action","blocked")});this.#handleNotificationElements()}#handleNotificationElements(){var $this=this;this.#notificationsElement.forEach(el=>{el.removeEventListener("click",function(ev){$this.#showHowToEnableMessage(this)});el.removeEventListener("click",function(ev){$this.#askPermission(this)});el.addEventListener("click",function(ev){$this.#handleClick(this)})})}#handleClick(el){if(el.classList.contains("main-alert-switch")){el.dataset.dataType="11";el.dataset.dataId="14109";el.dataset.tagName="ultima-hora";this.#subscribeToItem(el)}else{try{this.#subscribeToItem(el)}catch(e){console.log(e)}}}#subscribeToItem(el){if(!el.dataset)return;var $this=this;const body={fonte:el.dataset.source||el.dataset.dataType,dadoId:el.dataset.id||el.dataset.dataId,dadoSlug:el.dataset.value||el.dataset.tagName,token:window.DeviceToken,fbToken:window.firebaseMessagingToken,playerId:""};if(body.fonte.indexOf("tag")==0)body.fonte="11";if(body.fonte.indexOf("autor")==0)body.fonte="68";var isCheckBox=el.nodeName=="INPUT"&&el.type=="checkbox";var isSubscribed=isCheckBox?!el.checked:el.classList.contains("subscribed");fetch("/api/notification/"+(!isSubscribed?"add":"remove"),{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},credentials:"include",body:JSON.stringify(body)}).then(function(result){if(result.status==200){result.json().then(function(data){if(isCheckBox)el.checked=!isSubscribed;else{$this.#changeElementState(el,!isSubscribed)}})}window.adding=false}).catch(e=>{window.adding=false})}#getUserSubscriptions(token,accept){var $this=this;fetch("/api/notification/?token="+token.split(":")[0]+":").then(response=>{if(response.status==200){response.json().then(data=>{if(data&&data.length>0){this.#notifications=data;this.#notificationsElement.forEach(el=>{if(data.find(d=>d.item1==el.dataset.dataType&&d.item2==el.dataset.dataId)!=undefined){$this.#changeElementState(el,true)}})}if(typeof accept=="function"){accept(this)}var ev=new CustomEvent("NotificationSubscriptionsReceived",{detail:{subscriptions:data}});document.dispatchEvent(ev)})}})}#changeElementState(el,isSubscribed){if(el.nodeName=="INPUT")el.checked=isSubscribed;else if(isSubscribed){el.innerHTML="<i class='icon i-bell-slash'></i>Cancelar alertas";el.classList.add("subscribed")}else{el.innerHTML="<i class='icon i-bell'></i>Receber alertas";el.classList.remove("subscribed")}}#showHowToEnable(notificationStatus){if(this.#notificationStatus=="default"&&document.location.pathname!="/alertas")this.#showNotificationModal();this.#notificationsElement.forEach(el=>{var $this=this;if(this.#notificationStatus=="default"){if(this.#browser==this.#browsers.EDGE){el.removeEventListener("click",function(ev){$this.#showHowToEnableMessage(this)});el.addEventListener("click",function(ev){$this.#showHowToEnableMessage(this)})}el.removeEventListener("click",function(ev){$this.#askPermission(this)});el.addEventListener("click",function(ev){$this.#askPermission(this)})}else if(notificationStatus=="denied"){el.removeEventListener("click",function(ev){$this.#showHowToEnableMessage(this)});el.addEventListener("click",function(ev){$this.#showHowToEnableMessage(this)})}})}#askPermission(el,accept){window.elClicked=el;Notification.requestPermission().then(permission=>{Publico.Track.Event("notifications","action",permission);if(permission=="granted"){this.#notificationStatus=permission;var ev=new Event("NotificationSubscriptionsGranted");document.dispatchEvent(ev);getToken(messaging,{vapidKey:serverKey}).then(token=>{if(token){this.#token=token;window.firebaseMessagingToken=token;var sessionToken=sessionStorage.getItem("fb_tk");if(sessionToken==null||sessionToken!=token){fetch("/api/notification/subscribe?token="+token,{credentials:"include"});sessionStorage.setItem("fb_tk",token)}if(typeof accept=="function"){accept(this)}Publico.Track.Event("notifications","action","allowed")}}).catch(err=>{Publico.Track.Event("notifications","action","blocked")});window.elClicked.removeEventListener("click",this.#askPermission);var $modal=$("#modal-alerts-alt");try{$modal.foundation("close")}catch(e){}this.#initMessaging()}})}#showHowToEnableMessage(el){let imgUrl="https://static.publicocdn.com/files/site/assets/img/notifications/";if(this.#browser==this.#browsers.EDGE){imgUrl+=this.#isMobile?"notifications--chrome-mobile.png":this.#platform.indexOf("mac")>-1?this.#notificationStatus=="default"?"notifications--edge-alt.png":"notifications--edge-mac.png":"notifications--edge-alt.png"}else if(this.#browser==this.#browsers.CHROME){imgUrl+=this.#isMobile?"notifications--chrome-mobile.png":"notifications--chrome-desktop.png"}else if(this.#browser==this.#browsers.SAFARI){imgUrl+=this.#isMobile?"":"notifications--safari.png"}else if(this.#browser==this.#browsers.FIREFOX){imgUrl+=this.#isMobile?"":"notifications--firefox.png"}else{imgUrl=""}if(imgUrl!=""){if(Publico.LoadDependencies){Publico.LoadDependencies(["jQuery","Foundation"]).then(()=>{this.#openNotificationMessage(imgUrl)})}else{this.#openNotificationMessage(imgUrl)}}}#openNotificationMessage(imgUrl){var $modal=$("#modal-alerts-alt");$modal.on("open.zf.reveal",function(){$("#modal-alerts-alt").find(".modal__body > div img").each(function(){$(this).attr("src",imgUrl)})});$modal.foundation("open")}#showNotificationModal(hasCustomParams,params){var lastSeen=localStorage.getItem("_nbs");if(lastSeen!=null){if((new Date).getTime()-lastSeen<24*60*60*1e3)return}let image="https://static.publico.pt/s3/notification-template/p.png";let message="Quer manter-se informado sobre os assuntos que lhe interessam?";let laterBtnCopy="Mais tarde";let laterBtnHref="#";let subscribeBtnCopy="Subscrever";let subscribeBtnHref="#";if(hasCustomParams==true){image=message=laterBtnCopy=laterBtnHref=subscribeBtnCopy=subscribeBtnHref="";if(Object.keys(params).length>0){if(params.image){image=params.image}if(params.message){message=params.message}if(params.laterBtnCopy){laterBtnCopy=params.laterBtnCopy}if(params.laterBtnHref){laterBtnHref=params.laterBtnHref}if(params.subscribeBtnCopy){subscribeBtnCopy=params.subscribeBtnCopy}if(params.subscribeBtnHref){subscribeBtnHref=params.subscribeBtnHref}}}let boxStyle=`<style id="notification-box-styles">.notification-box-container { position: fixed; z-index: 999999999; width: 100%; pointer-events: none; } .notification-box-wrapper * { margin: 0; padding: 0; border: 0; box-sizing: border-box; } .notification-box-wrapper { display: flex; flex-flow: column wrap; width: 100%; max-width: 362px; background-color: #FFFFFF; padding: 23px; margin: 0 auto; box-sizing: border-box; border-radius: 0 0 8px 8px; box-shadow: 0px 0px 6px #1a1e224a; border: 1px solid #dedede; pointer-events: all; } .notification-box-wrapper .notification-info { display: flex; flex-flow: row wrap; justify-content: space-between; gap: 0 18px; margin: 0 0 10px 0; } .notification-box-wrapper .notification-info .notification-image { width: 80px; height: 80px; background-image: url(${image}); background-size: contain; background-repeat: no-repeat; } .notification-box-wrapper .notification-info .notification-message { flex: 1; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; font-weight: 400; font-size: 16px; line-height: 140%; letter-spacing: 0px; color: #1a1e22; } .notification-box-wrapper .notification-ctas { display: flex; flex-flow: row wrap; justify-content: flex-end; align-items: center; gap: 0 37px; } .notification-box-wrapper .notification-ctas .btn-later { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; font-weight: 500; font-size: 16px; line-height: 140%; letter-spacing: 0px; text-decoration: none; color: #D10019; } .notification-box-wrapper .notification-ctas .btn-subscribe { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; font-weight: 500; font-size: 16px; line-height: 140%; letter-spacing: 0px; text-decoration: none; color: #FFFFFF; background-color: #D10019; border-radius: 4px; padding: 14px 26px; } @media screen and (min-width: 1024px) { .notification-box-wrapper { max-width: 500px; } } /* Fade */ .notification-box-container.fade { transform: translateY(-100%); opacity: 0; animation: fade-notification .5s linear; animation-fill-mode: forwards;; } @keyframes fade-notification { 0% {transform: translateY(-100%);opacity:0;} 100% {transform: translateY(0);opacity:1} }</style>`;let boxHtml=`<div id="notification-box" class="notification-box-container fade"> <div class="notification-box-wrapper"> <div class="notification-info"> <div class="notification-image"></div> <p class="notification-message">${message}</p> </div> <div class="notification-ctas"> <a href="${laterBtnHref}" class="btn-later">${laterBtnCopy}</a> <a href="${subscribeBtnHref}" class="btn-subscribe">${subscribeBtnCopy}</a> </div> </div> </div>`;let boxScript=document.createElement("script");boxScript.id="notification-box-script";boxScript.innerHTML=`
                document.addEventListener("click", function(event) {
                    if (event.target.matches(".notification-box-wrapper .btn-later")) {
                        document.querySelector("#notification-box").remove();
                        localStorage.setItem("_nbs", (new Date).getTime());
                        dataLayer.push({ "event": "notification_popup", "clicked": "later" });
                    }
                    if (event.target.matches(".notification-box-wrapper .btn-subscribe")) {
                        Publico.Notifications._getInstance().subscribeToArticle();
                        document.querySelector("#notification-box").remove();
                        dataLayer.push({ "event": "notification_popup", "clicked": "subscribe" });
                    }
                });`;if(document.querySelector("#notification-box-styles")){document.querySelector("#notification-box-styles").remove()}if(document.querySelector("#notification-box")){document.querySelector("#notification-box").remove()}let targetElement=document.querySelector("body");targetElement.insertAdjacentHTML("afterbegin",boxStyle+boxHtml);if(!document.querySelector("#notification-box-script")){document.querySelector("body").appendChild(boxScript)}}constructor(){this.#browser=this.#browsers.UNSUPORTED;if(window._publicoNotificationInstance)throw"use _getInstance";if(this.#mainSwitches.length>0)this.#notificationsElement=this.#notificationsElement.concat(...this.#mainSwitches);if(this.#subscribeSwitches)this.#notificationsElement=this.#notificationsElement.concat(...this.#subscribeSwitches);if(this.#userAgent==undefined||this.#userAgent==null)this.#userAgent="";if(this.#userAgent.indexOf("Edg/")>-1){this.#browser=this.#browsers.EDGE}else if(this.#userAgent.indexOf("Chrome/")>-1){this.#browser=this.#browsers.CHROME}else if(this.#userAgent.indexOf("Safari/")>-1){this.#browser=this.#browsers.SAFARI}else if(this.#userAgent.indexOf("Firefox/")>-1){this.#browser=this.#browsers.FIREFOX}}init(){if(this.#notificationStatus=="granted"){this.#initMessaging();var ev=new Event("NotificationSubscriptionsGranted");document.dispatchEvent(ev)}else{switch(this.#notificationStatus){case"default":this.#showHowToEnable(this.#notificationStatus);break;case"denied":this.#showHowToEnable(this.#notificationStatus);break;default:console.log("unknown notification status")}}document.addEventListener("subscribeToArticle",function(){Publico.Notifications._getInstance().subscribeToArticle()})}addElement(el){var $this=this;this.#subscribeSwitches=[...this.#subscribeSwitches,el];this.#notificationsElement=[...this.#notificationsElement,el];el.addEventListener("click",function(ev){$this.#handleClick(this)})}subscribeToArticle(){if(this.#notificationStatus=="default"){this.#askPermission(document.body,this.continueToSubscriptions);return}if(this.#notificationStatus=="granted"){this.#getUserSubscriptions(this.#token,this.continueToSubscriptions);return}if(this.#notificationStatus=="denied"){this.#showHowToEnableMessage(document.body);return}}continueToSubscriptions(obj){if(obj.#notificationStatus!="granted"){this.subscribeToArticle();return}var $container=$("#modal-alerts-manage-single");$container.foundation("open");if(!window.setupDone){window.setupDone=true;obj.#getUserSubscriptions(obj.#token,obj.continueInArticle)}}continueInArticle(obj){if(obj.#notificationStatus!="granted"){obj.subscribeToArticle();return}var notifications=obj.#notifications;var $container=$("#modal-alerts-manage-single");if(typeof dataLayer=="object"){var articleOptions=dataLayer[0].notifications;if(articleOptions!=null){var html="";if(articleOptions.authors&&articleOptions.authors.length>0){html+='<div class="l-mosaic__item"><h4 class="modal__sub-title">Autores</h4><div class="switch-list switch-list--alerts">';articleOptions.authors.forEach(function(a){var userNotification=notifications.filter(n=>n.item1=="autores"&&n.item4==a.slug);html+='<div class="switch-list__item"><div class="switch-list__label">'+a.name+"</div>"+'<div class="switch small"><input class="switch-input"'+(userNotification.length>0?"checked":"")+' id="switch'+a.id+'" type="checkbox" data-source="autor" data-saved="'+(userNotification.length>0?"true":"false")+'" data-data-name="'+a.name+'" data-id="'+a.id+'" data-value="'+a.slug+'">'+'<label class="switch-paddle" for="switch'+a.id+'"><span class="show-for-sr"></span>'+"</label></div></div>"});html+="</div></div>"}if(articleOptions.tags&&articleOptions.tags.length>0){html+='<div class="l-mosaic__item"><h4 class="modal__sub-title">TÃ³picos</h4><div class="switch-list switch-list--alerts">';articleOptions.tags.forEach(function(t){var userNotification=notifications.filter(n=>n.item1=="tags"&&n.item4==t.slug);html+='<div class="switch-list__item"><div class="switch-list__label">'+t.name+"</div>"+'<div class="switch small"><input class="switch-input"'+(userNotification.length>0?"checked":"")+' id="switch'+t.id+'" type="checkbox" data-source="tag" data-saved="'+(userNotification.length>0?"true":"false")+'" data-data-name="'+t.name+'" data-id="'+t.id+'" data-value="'+t.slug+'">'+'<label class="switch-paddle" for="switch'+t.id+'"><span class="show-for-sr"></span>'+"</label></div></div>"});html+="</div></div>"}}var $optionsContainer=$container.find(".alerts-manager");$optionsContainer.append(html);$optionsContainer[0].querySelectorAll(".switch-input").forEach(el=>{el.addEventListener("click",function(){obj.#handleClick(el)})})}$container.find(".lazy-loading").remove();$container.find(".modal__header p").attr("style","color:#000")}static _getInstance(){if(window._publicoNotificationInstance)return window._publicoNotificationInstance;window._publicoNotificationInstance=new Publico.Notifications;return window._publicoNotificationInstance}test(){this.#showNotificationModal()}};var instance=Publico.Notifications._getInstance();instance.init()});if(notificationToggle!=null){notificationToggle.addEventListener("click",function(){document.dispatchEvent(new Event("subscribeToArticle"))})}}else{if(notificationToggle!=null){notificationToggle.remove()}}